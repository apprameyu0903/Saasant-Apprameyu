package com.dao;
import java.util.*;
import com.util.DBUtil; //
import com.vo.CustomerDetails; //

import java.sql.*;

public class CustomerDao implements CustomerDaoInterface{

    public boolean addCustomer(CustomerDetails customer) {
        String sql = "insert into customers (customer_id, customer_name, customer_mobile, customer_location) values (?, ?, ?, ?)";

        // Changed to use singleton instance
        try (Connection conn = DBUtil.getInstance().getConnection(); //
             PreparedStatement stmt = conn.prepareStatement(sql)) {

            if (getCustomerById(customer.getCustomerId()) != null) {
                System.out.println("❗ Customer ID already exists.");
                return false;
            }

            stmt.setString(1, customer.getCustomerId());
            stmt.setString(2, customer.getCustomerName());
            stmt.setString(3, customer.getMobileNumber());
            stmt.setString(4, customer.getCustomerLocation());

            int rows = stmt.executeUpdate();
            return rows > 0;

        } catch (SQLException e) {
            e.printStackTrace();
            System.out.println("Error in the DB Connectivity");
        }
        return false;
    }

    public CustomerDetails getCustomerById(String customerId) {
        String sql = "SELECT * FROM customers WHERE customer_id = ?";

        // Changed to use singleton instance
        try (Connection conn = DBUtil.getInstance().getConnection(); //
             PreparedStatement stmt = conn.prepareStatement(sql)) {

            stmt.setString(1, customerId);
            ResultSet rs = stmt.executeQuery();
            CustomerDetails customer = new CustomerDetails(); //
            if (rs.next()) {
                // It's good practice to set the ID as well
                customer.setCustomerId(customerId);
                customer.setCustomerName(rs.getString("customer_name"));
                customer.setMobileNumber(rs.getString("customer_mobile"));
                customer.setCustomerLocation(rs.getString("customer_location"));
                return customer;
            }

        } catch (SQLException e) {
            e.printStackTrace();
            System.out.println("Error in the DB Connectivity");
        }
        return null;
    }

    public boolean updateCustomer(CustomerDetails customer) {
        String sql = "UPDATE customers SET customer_name = ?, customer_mobile = ?, customer_location = ? WHERE customer_id = ?";

        // Changed to use singleton instance
        try (Connection conn = DBUtil.getInstance().getConnection(); //
             PreparedStatement stmt = conn.prepareStatement(sql)) {

            stmt.setString(1, customer.getCustomerName());
            stmt.setString(2, customer.getMobileNumber());
            stmt.setString(3, customer.getCustomerLocation()); // Corrected: customer_location is the 3rd SET parameter
            stmt.setString(4, customer.getCustomerId()); // customer_id is the 4th parameter (for WHERE clause)

            int rows = stmt.executeUpdate();
            return rows > 0;

        } catch (SQLException e) {
            e.printStackTrace();
            System.out.println("Error in the DB Connectivity");
        }
        return false;
    }

    public boolean deleteCustomer(String customerId) {
        String sql = "DELETE FROM customers WHERE customer_id = ?";

        // Changed to use singleton instance
        try (Connection conn = DBUtil.getInstance().getConnection(); //
             PreparedStatement stmt = conn.prepareStatement(sql)) {

            stmt.setString(1, customerId);
            int rows = stmt.executeUpdate();
            return rows > 0;

        } catch (SQLException e) {
            e.printStackTrace();
            System.out.println("Error in the DB Connectivity");
        }
        return false;
    }

    public List<CustomerDetails> getAllCustomers() {
        List<CustomerDetails> customers = new ArrayList<>();
        String sql = "SELECT * FROM customers";

        // Changed to use singleton instance
        try (Connection conn = DBUtil.getInstance().getConnection(); //
             Statement stmt = conn.createStatement();
             ResultSet rs = stmt.executeQuery(sql)) {

            while (rs.next()) {
                // Instantiate CustomerDetails inside the loop to add new objects to the list
                CustomerDetails customer = new CustomerDetails(); //
                customer.setCustomerId(rs.getString("customer_id"));
                customer.setCustomerName(rs.getString("customer_name"));
                customer.setMobileNumber(rs.getString("customer_mobile"));
                customer.setCustomerLocation(rs.getString("customer_location"));
                customers.add(customer);
            }

        } catch (SQLException e) {
            e.printStackTrace();
            System.out.println("Error in the DB Connectivity");
        }
        return customers;
    }
}
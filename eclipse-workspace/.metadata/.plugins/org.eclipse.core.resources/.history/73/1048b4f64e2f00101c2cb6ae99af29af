package com.controller;
import com.vo.CustomerDetails;
import com.dao.CustomerDao;
import java.util.*;
import java.io.IOException;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/**
 * Servlet implementation class CustomerServlet
 */
@WebServlet("/CustomerServlet")
public class CustomerServlet extends HttpServlet {
	private static final long serialVersionUID = 1L;
	private CustomerDao customerDao = new CustomerDao();
       
    /**
     * @see HttpServlet#HttpServlet()
     */
    public CustomerServlet() {
        super();
        // TODO Auto-generated constructor stub
    }

	/**
	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		// TODO Auto-generated method stub
		
		String action = request.getParameter("action");
        String forwardPage = "/customer_details.jsp"; 

        if ("edit".equals(action)) {
            String customerId = request.getParameter("id");
            CustomerDetails customer = customerDao.getCustomerById(customerId);
            request.setAttribute("customer", customer);
            forwardPage = "/edit_customer.jsp";

        } else if ("showAddForm".equals(action)) {
             forwardPage = "/add_customer.jsp";

        } else if ("delete".equals(action)) {
             String customerId = request.getParameter("id");
             customerDao.deleteCustomer(customerId);
             response.sendRedirect("CustomerServlet?message=Customer+deleted+successfully");
             return; 

        } else {
            List<CustomerDetails> customerList = customerDao.getAllCustomers();
            request.setAttribute("customers", customerList);
            request.setAttribute("successMessage", request.getParameter("message"));
            request.setAttribute("errorMessage", request.getParameter("error"));
            forwardPage = "/customer_details.jsp";
        }

      
        RequestDispatcher dispatcher = request.getRequestDispatcher(forwardPage);
        dispatcher.forward(request, response);
	}

	/**
	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		// TODO Auto-generated method stub
		String action = request.getParameter("action");
        String redirectUrl = "CustomerServlet"; 

        if ("add".equals(action)) {
            CustomerDetails customer = new CustomerDetails();
            String customerId = request.getParameter("customerId");
            customer.setCustomerId(customerId);
            customer.setCustomerName(request.getParameter("customerName"));
            customer.setMobileNumber(request.getParameter("mobileNumber"));
            customer.setCustomerLocation(request.getParameter("customerLocation"));

            // Add the customer to the database
            boolean added = customerDao.addCustomer(customer);

            if (added) {
                 // ***MODIFIED REDIRECT***: Redirect back to the list view with a success message
                redirectUrl = "CustomerServlet?message=Customer+added+successfully";
            } else {
                // If add failed, redirect back to the add form with an error flag (optional)
                redirectUrl = "CustomerServlet?action=showAddForm&error=true";
            }

        } else if ("update".equals(action)) {
            // Get data submitted from the edit form
            CustomerDetails customer = new CustomerDetails();
            String customerId = request.getParameter("customerId"); // Get ID from hidden field
            customer.setCustomerId(customerId);
            customer.setCustomerName(request.getParameter("customerName"));
            customer.setMobileNumber(request.getParameter("mobileNumber"));
            customer.setCustomerLocation(request.getParameter("customerLocation"));

            // Update the customer in the database
            boolean updated = customerDao.updateCustomer(customer);

            if (updated) {
                 // Redirect to the details page for the updated customer (or change this too if needed)
                redirectUrl = "customer_details.jsp?id=" + customerId + "&message=Customer+updated+successfully";
            } else {
                 // If update failed, redirect back to the edit form with an error flag (optional)
                redirectUrl = "CustomerServlet?action=edit&id=" + customerId + "&error=true";
            }
        }

        // Perform the redirect after adding or updating
        response.sendRedirect(redirectUrl);
	}
        
      	
}



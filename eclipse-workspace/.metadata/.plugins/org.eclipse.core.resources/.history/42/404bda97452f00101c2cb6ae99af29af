package com.controller;
import com.vo.CustomerDetails;
import com.dao.CustomerDao;
import java.util.*;
import java.io.IOException;
import java.net.URLEncoder;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/**
 * Servlet implementation class CustomerServlet
 */
@WebServlet("/CustomerServlet")
public class CustomerServlet extends HttpServlet {
	private static final long serialVersionUID = 1L;
	private CustomerDao customerDao = new CustomerDao();
       
    /**
     * @see HttpServlet#HttpServlet()
     */
    public CustomerServlet() {
        super();
        // TODO Auto-generated constructor stub
    }

	/**
	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		// TODO Auto-generated method stub
		
		String action = request.getParameter("action");
        String forwardPage = "/customerList.jsp"; // Default page is the list

        if ("edit".equals(action)) {
            // Get the ID of the customer to edit
            String customerId = request.getParameter("id");
            // Fetch the customer details from the database
            CustomerDetails customer = customerDao.getCustomerById(customerId);
            // Pass the customer object to the JSP
            request.setAttribute("customer", customer);
            // Set the page to forward to as the edit form
            forwardPage = "/editCustomer.jsp";

        } else if ("showAddForm".equals(action)) {
             // Set the page to forward to as the add form
             forwardPage = "/addCustomer.jsp";

        } else if ("delete".equals(action)) {
             // Get the ID of the customer to delete
             String customerId = request.getParameter("id");
             // Attempt to delete the customer
             customerDao.deleteCustomer(customerId);
             // Redirect back to the main servlet (which will show the list)
             // We'll add success/error messages later if needed
             response.sendRedirect("CustomerServlet");
             return; // Stop further processing after redirect

        } else {
            // Default action: Show the list of customers
            // Get all customers from the database
            List<CustomerDetails> customerList = customerDao.getAllCustomers();
            // Pass the list to the JSP
            request.setAttribute("customers", customerList);
            // Keep the forward page as the list page
            forwardPage = "/customerList.jsp";
        }

        // Forward the request to the appropriate JSP page
        RequestDispatcher dispatcher = request.getRequestDispatcher(forwardPage);
        dispatcher.forward(request, response);
	}

	/**
	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		// TODO Auto-generated method stub
		String action = request.getParameter("action");
        String redirectUrl = "CustomerServlet"; // Default redirect to list

        try {
            if ("add".equals(action)) {
                // Action: Add New Customer
                CustomerDetails customer = new CustomerDetails();
                // Retrieve data from the submitted form
                customer.setCustomerId(request.getParameter("customerId"));
                customer.setCustomerName(request.getParameter("customerName"));
                customer.setMobileNumber(request.getParameter("mobileNumber"));
                customer.setCustomerLocation(request.getParameter("customerLocation"));

                boolean added = customerDao.addCustomer(customer);
                
                String successMsg = URLEncoder.encode("Customer added successfully", "UTF-8");
                		
                if (added) {
                	redirectUrl = "customer_details.jsp?id=" + URLEncoder.encode(customer.getCustomerId(), "UTF-8") + "&message=" + successMsg;
                } else {
                    // Redirect back to add form with error (ID might exist, or DB issue)
                    redirectUrl = "CustomerServlet?action=showAddForm&error=Failed+to+add+customer+(ID+might+exist+or+invalid+data)";
                }
            } else if ("update".equals(action)) {
                // Action: Update Existing Customer
                CustomerDetails customer = new CustomerDetails();
                String customerId = request.getParameter("customerId"); // Get ID from hidden field
                // Retrieve data from the submitted form
                customer.setCustomerId(customerId);
                customer.setCustomerName(request.getParameter("customerName"));
                customer.setMobileNumber(request.getParameter("mobileNumber"));
                customer.setCustomerLocation(request.getParameter("customerLocation"));
                
                String successMsg = URLEncoder.encode("Customer added successfully", "UTF-8");

                // Check if ID is valid before attempting update
                if (customerId == null || customerId.trim().isEmpty()) {
                     redirectUrl = "CustomerServlet?error=Cannot+update+customer+with+missing+ID";
                } else {
                    boolean updated = customerDao.updateCustomer(customer);
                    if (updated) {
                    	redirectUrl = "customer_details.jsp?id=" + URLEncoder.encode(customer.getCustomerId(), "UTF-8") + "&message=" + successMsg;
                    } else {
                        // Redirect back to edit form with error
                        redirectUrl = "CustomerServlet?action=edit&id=" + customerId + "&error=Failed+to+update+customer";
                    }
                }
            } else {
                 // Unknown POST action
                 redirectUrl = "CustomerServlet?error=Unknown+form+submission";
            }
        } catch (Exception e) {
            // Handle unexpected errors during POST processing
            e.printStackTrace(); // Log the full error
             redirectUrl = "CustomerServlet?error=An+unexpected+error+occurred+during+submission";
        }
        // Perform the redirect after processing the POST action
        response.sendRedirect(redirectUrl);
    }
        
      	
}


